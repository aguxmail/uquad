F = @(x,y,z,psi,phi,theta,vqx,vqy,vqz,wqx,wqy,wqz,ax,ay,az,w,dw,TM,D) ...
	[ ... 
    1, 0, 0,                          T*(vqz*(cos(psi)*sin(theta) - cos(theta)*sin(phi)*sin(psi)) + vqy*cos(psi)*cos(theta)*sin(phi)), T*(vqy*(sin(phi)*sin(theta) + cos(phi)*cos(theta)*sin(psi)) - vqx*cos(theta)*sin(phi) + vqz*cos(phi)*cos(psi)*cos(theta)), -T*(vqy*(cos(phi)*cos(theta) + sin(phi)*sin(psi)*sin(theta)) - vqz*(cos(theta)*sin(psi) - cos(psi)*sin(phi)*sin(theta)) + vqx*cos(phi)*sin(theta)), T*cos(phi)*cos(theta), -T*(cos(phi)*sin(theta) - cos(theta)*sin(phi)*sin(psi)),  T*(sin(psi)*sin(theta) + cos(psi)*cos(theta)*sin(phi)),                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                          0;
    0, 1, 0, -T*(vqy*(cos(theta)*sin(psi) - cos(psi)*sin(phi)*sin(theta)) + vqz*(cos(psi)*cos(theta) + sin(phi)*sin(psi)*sin(theta))),                         T*(vqz*cos(phi)*cos(psi)*sin(theta) - vqx*sin(phi)*sin(theta) + vqy*cos(phi)*sin(psi)*sin(theta)),  T*(vqz*(sin(psi)*sin(theta) + cos(psi)*cos(theta)*sin(phi)) - vqy*(cos(psi)*sin(theta) - cos(theta)*sin(phi)*sin(psi)) + vqx*cos(phi)*cos(theta)), T*cos(phi)*sin(theta),  T*(cos(psi)*cos(theta) + sin(phi)*sin(psi)*sin(theta)), -T*(cos(theta)*sin(psi) - cos(psi)*sin(phi)*sin(theta)),                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                          0;
    0, 0, 1,                                                                      T*(vqy*cos(phi)*cos(psi) - 2*vqz*cos(psi)*sin(psi)),                                                                                 -T*(vqx*cos(phi) + vqy*sin(phi)*sin(psi)),                                                                                                                                                  0,           -T*sin(phi),                                     T*cos(phi)*sin(psi),                                            T*cos(psi)^2,                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                          0;
    0, 0, 0,                                                                    T*(wqy*cos(psi)*tan(phi) - wqz*sin(psi)*tan(phi)) + 1,                                                         T*(wqz*cos(psi)*(tan(phi)^2 + 1) + wqy*sin(psi)*(tan(phi)^2 + 1)),                                                                                                                                                  0,                     0,                                                       0,                                                       0,                                                                                                                                                                                                                                                                                            T,                                                                                                                                                                                                                    T*sin(psi)*tan(phi),                                                                                                                                                                                                                                                                                                                                                                                                                                        T*cos(psi)*tan(phi);
    0, 0, 0,                                                                                         -T*(wqz*cos(psi) + wqy*sin(psi)),                                                                                                                         1,                                                                                                                                                  0,                     0,                                                       0,                                                       0,                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                             T*cos(psi),                                                                                                                                                                                                                                                                                                                                                                                                                                                -T*sin(psi);
    0, 0, 0,                                                                    T*((wqy*cos(psi))/cos(phi) - (wqz*sin(psi))/cos(phi)),                                               T*((wqz*cos(psi)*sin(phi))/cos(phi)^2 + (wqy*sin(phi)*sin(psi))/cos(phi)^2),                                                                                                                                                  1,                     0,                                                       0,                                                       0,                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                  (T*sin(psi))/cos(phi),                                                                                                                                                                                                                                                                                                                                                                                                                                      (T*cos(psi))/cos(phi);
    0, 0, 0,                                              (M*g*wqy*cos(phi)*cos(psi) - M*g*wqx*cos(phi)*sin(psi))/(M*wqy*(wqx - wqz)),                           -(M*g*wqx*cos(phi) + M*g*wqx*cos(psi)*sin(phi) + M*g*wqy*sin(phi)*sin(psi))/(M*wqy*(wqx - wqz)),                                                                                                                                                  0,                     0,                                                       0,                                                       0, (TM(1)*wqx + TM(2)*wqx + TM(3)*wqx + TM(4)*wqx - M*ax*wqx - M*ay*wqy - M*az*wqx + M*g*wqx*sin(phi) - M*g*wqx*cos(phi)*cos(psi) - M*g*wqy*cos(phi)*sin(psi))/(M*wqy*(wqx - wqz)^2) - (TM(1) + TM(2) + TM(3) + TM(4) - M*ax - M*az + M*g*sin(phi) - M*g*cos(phi)*cos(psi))/(M*wqy*(wqx - wqz)), (M*ay + M*g*cos(phi)*sin(psi))/(M*wqy*(wqx - wqz)) + (TM(1)*wqx + TM(2)*wqx + TM(3)*wqx + TM(4)*wqx - M*ax*wqx - M*ay*wqy - M*az*wqx + M*g*wqx*sin(phi) - M*g*wqx*cos(phi)*cos(psi) - M*g*wqy*cos(phi)*sin(psi))/(M*wqy^2*(wqx - wqz)),                                                                                                                                                                                                                                                                         -(TM(1)*wqx + TM(2)*wqx + TM(3)*wqx + TM(4)*wqx - M*ax*wqx - M*ay*wqy - M*az*wqx + M*g*wqx*sin(phi) - M*g*wqx*cos(phi)*cos(psi) - M*g*wqy*cos(phi)*sin(psi))/(M*wqy*(wqx - wqz)^2);               
    0, 0, 0,                                              (M*g*wqy*cos(phi)*cos(psi) - M*g*wqz*cos(phi)*sin(psi))/(M*wqz*(wqx - wqz)),                           -(M*g*wqx*cos(phi) + M*g*wqz*cos(psi)*sin(phi) + M*g*wqy*sin(phi)*sin(psi))/(M*wqz*(wqx - wqz)),                                                                                                                                                  0,                     0,                                                       0,                                                       0,                                                                (M*ax - M*g*sin(phi))/(M*wqz*(wqx - wqz)) + (TM(1)*wqz + TM(2)*wqz + TM(3)*wqz + TM(4)*wqz - M*ax*wqx - M*ay*wqy - M*az*wqz + M*g*wqx*sin(phi) - M*g*wqz*cos(phi)*cos(psi) - M*g*wqy*cos(phi)*sin(psi))/(M*wqz*(wqx - wqz)^2),                                                                                                                                                                                     (M*ay + M*g*cos(phi)*sin(psi))/(M*wqz*(wqx - wqz)), (TM(1)*wqz + TM(2)*wqz + TM(3)*wqz + TM(4)*wqz - M*ax*wqx - M*ay*wqy - M*az*wqz + M*g*wqx*sin(phi) - M*g*wqz*cos(phi)*cos(psi) - M*g*wqy*cos(phi)*sin(psi))/(M*wqz^2*(wqx - wqz)) - (TM(1)*wqz + TM(2)*wqz + TM(3)*wqz + TM(4)*wqz - M*ax*wqx - M*ay*wqy - M*az*wqz + M*g*wqx*sin(phi) - M*g*wqz*cos(phi)*cos(psi) - M*g*wqy*cos(phi)*sin(psi))/(M*wqz*(wqx - wqz)^2) - (TM(1) + TM(2) + TM(3) + TM(4) - M*az - M*g*cos(phi)*cos(psi))/(M*wqz*(wqx - wqz));
    0, 0, 0,                                              (M*g*wqy*cos(phi)*cos(psi) - M*g*wqz*cos(phi)*sin(psi))/(M*wqy*(wqx - wqz)),                           -(M*g*wqz*cos(phi) + M*g*wqz*cos(psi)*sin(phi) + M*g*wqy*sin(phi)*sin(psi))/(M*wqy*(wqx - wqz)),                                                                                                                                                  0,                     0,                                                       0,                                                       0,                                                                                                            (TM(1)*wqz + TM(2)*wqz + TM(3)*wqz + TM(4)*wqz - M*ax*wqz - M*ay*wqy - M*az*wqz + M*g*wqz*sin(phi) - M*g*wqz*cos(phi)*cos(psi) - M*g*wqy*cos(phi)*sin(psi))/(M*wqy*(wqx - wqz)^2), (M*ay + M*g*cos(phi)*sin(psi))/(M*wqy*(wqx - wqz)) + (TM(1)*wqz + TM(2)*wqz + TM(3)*wqz + TM(4)*wqz - M*ax*wqz - M*ay*wqy - M*az*wqz + M*g*wqz*sin(phi) - M*g*wqz*cos(phi)*cos(psi) - M*g*wqy*cos(phi)*sin(psi))/(M*wqy^2*(wqx - wqz)),                                                                                                                                                             - (TM(1) + TM(2) + TM(3) + TM(4) - M*ax - M*az + M*g*sin(phi) - M*g*cos(phi)*cos(psi))/(M*wqy*(wqx - wqz)) - (TM(1)*wqz + TM(2)*wqz + TM(3)*wqz + TM(4)*wqz - M*ax*wqz - M*ay*wqy - M*az*wqz + M*g*wqz*sin(phi) - M*g*wqz*cos(phi)*cos(psi) - M*g*wqy*cos(phi)*sin(psi))/(M*wqy*(wqx - wqz)^2);        
    0, 0, 0,                                                                                                                        0,                                                                                                                         0,                                                                                                                                                  0,                     0,                                                       0,                                                       0,                                                                                                                                                                                                                                                                                            1,                                                                                                                                                                           (T*(wqz*(Iyy - Izz) + Izzm*(w(1) - w(2) + w(3) - w(4))))/Ixx,                                                                                                                                                                                                                                                                                                                                                                                                                                    (T*wqy*(Iyy - Izz))/Ixx;
    0, 0, 0,                                                                                                                        0,                                                                                                                         0,                                                                                                                                                  0,                     0,                                                       0,                                                       0,                                                                                                                                                                                                                                -(T*(wqz*(Ixx - Izz) - Izzm*(w(1) - w(2) + w(3) - w(4))))/Iyy,                                                                                                                                                                                                                                      1,                                                                                                                                                                                                                                                                                                                                                                                                                                   -(T*wqx*(Ixx - Izz))/Iyy;
    0, 0, 0,                                                                                                                        0,                                                                                                                         0,                                                                                                                                                  0,                     0,                                                       0,                                                       0,                                                                                                                                                                                                                                                                                            0,                                                                                                                                                                                                                                      0,                                                                                                                                                                                                                                                                                                                                                                                                                                                           1 ...
    ];
 
H = @(psi,phi,theta,vqx,vqy,vqz,wqx,wqy,wqz) ...
    [ ...
    0, 0, 0,                    1,                   0, 0,    0,    0,    0,   0,    0,    0;
    0, 0, 0,                    0,                   1, 0,    0,    0,    0,   0,    0,    0;
    0, 0, 0,                    0,                   0, 1,    0,    0,    0,   0,    0,    0;
    0, 0, 0,                    0,          g*cos(phi), 0,    0,  wqz, -wqy,   0, -vqz,  vqy;
    0, 0, 0, -g*cos(phi)*cos(psi), g*sin(phi)*sin(psi), 0, -wqz,    0,  wqx, vqz,    0, -vqx;
    0, 0, 0,  g*cos(phi)*sin(psi), g*cos(psi)*sin(phi), 0,  wqy, -wqz,    0,   0,  vqx, -vqy;
    0, 0, 0,                    0,                   0, 0,    0,    0,    0,   1,    0,    0;
    0, 0, 0,                    0,                   0, 0,    0,    0,    0,   0,    1,    0;
    0, 0, 0,                    0,                   0, 0,    0,    0,    0,   0,    0,    1 ...
    ];