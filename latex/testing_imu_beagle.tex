\documentclass[main]{subfiles}
\begin{document}

\chapter{Testeo del Beagleboard y el \textit{IMU}}

Durante la elección del hardware se buscó información sobre el \textit{Beagleboard} (de ahora en más ``\textit{\textit{BB}}'') y sobre el \textit{Atomic IMU} (de ahora en más ``\textit{IMU}''), y se concluyó que serían suficientes para los requerimientos del proyecto. En este capítulo se explican las pruebas realizadas sobre ambas placas. Los objetivos de dichas pruebas fueron:

\begin{itemize}
\item Verificar el correcto funcionamiento de las placas.
\item Confirmar que cumplen con los requerimientos del proyecto.
\end{itemize}

\section{Testeo del Beagleboard}
\label{sec:testeo_del_beagleboard}

El microcontrolador a bordo del \textit{BB} (de ahora en más ``\textit{omap}'') es suficiente para manejar el loop de control, y tiene un \textit{DSP}, por lo que la capacidad de procesamiento no debería ser un problema. La evaluación de dicha capacidad se hará más adelante, cuando se cuente con software adecuado. Por ahora solamente se analizó la disponibilidad de señales \textit{PWM}.

\subsection{\textit{PWM}}
\label{sec:beagleboard_pwm}

El \textit{omap} cuenta con 4 módulo para \textit{PWM} implementados en hardware. Para poder utilizarlos es necesario deshabilitar una función de ahorro de energía en el kernel. Se utilizó \href{http://www.openembedded.org}{OpenEmbedded} para compilar un kernel adecuado.

Se utilizó un driver hecho por \href{https://github.com/scottellis/omap3-pwm}{Scottellis} para manejar el acceso a registros en el \textit{omap}. Puede que no sea necesario manejar los \textit{PWM} desde el kernel, ya que la implementación está en hardware, por lo que se está considerando pasa a usar un programa en \textit{user space}, evitando los riesgos de trabajar a bajo nivel. Un error a nivel de kernel podría dejar deshabilitar el \textit{BB}, lo cual llevaría inevitablemente a perder el control del cuadricóptero.

Solamente 3 de los 4 \textit{PWM} están mapeados a pines accesibles en el \textit{BB}. Para tener acceso al cuarto \textit{PWM} es necesario modificar la configuración de muxing en el \textit{omap}. Habilitar el cuarto \textit{PWM} trae al menos dos problemas:
\begin{enumerate}
\item Queda inutilizable el integrado \verb+U14+, que es un \textit{Hi-Speed USB 2.0 Transceiver}.
\item Hace falta conectar un cable a un punto en la mitad del \textit{BB} para ver la señal de \textit{PWM}.
\end{enumerate}

Se encontraron comentarios en foros sobre posibles problemas al utilizar los \textit{PWM} en conjunto con el \textit{DSP}, pero no se encontró información que confirmara esto en las hojas de datos, y todavía no se cuenta con software adecuado para hacer pruebas.

Se determinó que es posible utilizar el \textit{BB} para generar 4 señales \textit{PWM}, pero con un costo que puede ser importante.\\

Alternativas bajo estudio:

\begin{itemize}
\item Utilizar alguno de los 6 \textit{PWM} disponibles en el microcontrolador a bordo del \textit{IMU}:
  \begin{itemize}
  \item Permitiría utilizar todas las funcionalidades del \textit{BB}.
  \item El \textit{IMU} puede quedar sobrecargado, resultando en pérdidas de datos de los sensores.
  \item El tiempo que tarda en llegar una orden emitida por el loop de control a su destino puede ser un problema Dicha orden tiene que seguir el siguiente camino:
    \begin{enumerate}
    \item Sale del \textit{BB} y va al \textit{IMU}.
    \item El \textit{IMU} configura el \textit{PWM} adecuadamente.
    \item La señal de \textit{PWM} va al \textit{ESC} correspondiente.
    \item El \textit{ESC} actúa sobre el motor correspondiente.
    \end{enumerate}
  \end{itemize}
\item Utilizar una tercer placa para generar los \textit{PWM}.
\end{itemize}

\newpage

\section{Testeo del \textit{IMU}}
\label{sec:testeo_imu}

%TODO replace IMU with textit

El microcontrolador a bordo del \textit{IMU} tiene un \textit{ADC} de 10 bits, a cuya entrada están conectadas, mediante muxing, las salidas de los sensores: 3 giróscopos y 3 acelerómetros\footnote{En realidad es 1 acelerómetro de 3 ejes.}.

El software que corre en el el \textit{IMU} permite configurar qué sensores se desean leer, y la frecuencia con la que se debe realizar el muestreo. Las lecturas se transmiten mediante una \textit{UART}. Esta información se puede ver en una PC utilizando un adaptador \textit{USB-serie}.

Para verificar el correcto funcionamiento del \textit{IMU} se partió de \cite{bib:jj_9dof}, un software escrito para el \href{http://www.sparkfun.com/products/9623}{Razor 9DOF}, y se lo modificó para adecuarlo al \textit{IMU}.

\subsection{Software de prueba}
\label{sec:testeo_imu_software_de_prueba}
Pseudocódigo:
\begin{framed}
\begin{enumerate}
\item Conectar a al puerto serie.
\item Inicializar un display que representa la estimación de la posición en la cual se encuentra el \textit{IMU}.
\item Correr dos threads:
  \begin{enumerate}
  \item Thread 1: Espera input del usuario. Se usa para cambiar la frecuencia de muestreo o la sensibilidad de los sensores.
  \item Thread 2: Lee datos del puerto serie y luego:
    \begin{itemize}
    \item Imprime a la consola.
    \item Escribe a un log.
    \item Actualiza el display.
    \end{itemize}
  \end{enumerate}
\end{enumerate}
\end{framed}

\begin{figure}[!ht]
\centering
	\includegraphics[width=0.7\textwidth]{./pics_testing_imu_beagle/imu_display.png}
	\caption{Programa para ver datos del \textit{IMU}.}
	\label{fig:imu_display}
\end{figure}

El programa permite elegir tres formas de manipular los datos de los sensores:
\begin{itemize}
\item Solamente giróscopos $\rightarrow$ \textit{Drift}
\item Solamente acelerómetros $\rightarrow$ Información ruidosa
\item Combinar giróscopos y acelerómetros $\rightarrow$ \textit{Kalman}
\end{itemize}

Se hace una calibración sencilla para tomar en cuenta el que el cero (``\textit{null}'') de los sensores no se corresponde exactamente con lectura cero.

El programa está hecho en python, su única función es mostrar que el \textit{IMU} funciona correctamente. Un software similar correrá en el BB, pero será escrito en \textit{C}.

\subsection{Tareas pendientes}
\label{sec:testeo_imu_tareas_pendientes}

Si se desea obtener información más ``limpia'' de los sensores es necesario mejorar la calibración.

Otro punto donde se podría mejorar es en el \textit{ADC}. La respuesta del \textit{ADC} se asume lineal, pero no lo es.

Si la performance de los sensores no resulta adecuada, se podría:
\begin{itemize}
\item Hacer una calibración que tome en cuenta no solamente la estimación del \textit{null}, sino también la ganancia y las no linealidades del sensor.
\item Caracterizar la no linealidad del \textit{ADC} y compensarla.
\end{itemize}

\newpage

\end{document}