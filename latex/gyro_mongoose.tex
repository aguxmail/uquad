\documentclass[main]{subfiles}



\newcommand{\HRule}{\rule{\linewidth}{0.5mm}}
\begin{document}

\chapter{Calibración del giróscopo}

\section{Objetivos}

\begin{itemize}
	\item Realizar una serie de pruebas con el fin de calibrar el giróscopo de tres ejes de la IMU.
	\item Estudiar, proponer y validar un modelo para dicha calibración.
	\item Estimar las fuentes de error del mismo (ruido y bias).
\end{itemize}

\section{Materiales}
\begin{itemize}
\item Mongoose 9Dof IMU de \emph{Ckdevices}
\item Beagleboard XM
\item Adaptador Wi-Fi 
\item Tocadiscos
\item Cronómetro
\item Cubo perfecto de madera
\item 2 escuadras de 45º
\item 2 escuadras de 30º
\item Madera de 4 cm de ancho con lados paralelos
\end{itemize}

\section{Marco teórico}
Para la calibración del giróscopo se utiliza el mismo modelo que se utilizó para el acelerómetro en la sección \ref{chap:calibracion_acelerometro}.

\begin{equation}
\tilde{\mathbf{w^a}}=K_w(T_a^p)^{-1}\mathbf{w^p}+\mathbf{b}_w
\label{ec:modelo_gyro}
\end{equation}

con $K_w$ matriz diagonal que representa el factor de escala para convertir del valor digital a la velocidad angular correspondiente, $\mathbf{b}_w$ un término independiente para corregir la medida de velocidad angular nula y $T^p_a$ una matriz que corrige la no ortogonalidad de los ejes:
$$T^p_a=\left( 
\begin{matrix}
1 &-\alpha_{yz} &\alpha_{zy}\\
\alpha_{xz} &1& -\alpha_{zx} \\
-\alpha_{xy} &\alpha_{yx} &1\\
\end{matrix} 
\right)$$

\section{Procedimiento}
\subsection{Caracterización de las no idealidades variables}

Para obtener más información sobre el \emph{ruido inherente} y el \emph{drift aleatorio} se toman datos durante una hora a una frecuencia de 100 Hz con el dispositivo quieto.

\subsection{Determinación de parámetros estáticos}

\begin{wraptable}{r}{0.4\textwidth}
\vspace{-15pt}
\centering
\begin{small}
\begin{tabular}{|c|c|c|}
\hline
  {\cellcolor[gray]{0.85} \centering \textbf{EGP}}
& {\cellcolor[gray]{0.85} \centering \textbf{EGS}}
& {\cellcolor[gray]{0.85} \centering \textbf{AG}} \\ \hline  \hline
x & z & 0 \\ \hline
x & z & 30 \\ \hline
x & z & 45 \\ \hline
y & x & 0 \\ \hline
y & x & 30 \\ \hline
y & x & 45 \\ \hline
z & y & 0 \\ \hline
z & y & 30 \\ \hline
z & y & 45 \\ \hline
\end{tabular}
\caption{Configuraciones utilizadas para calibrar el giróscopo.}
\label{tab:gyros}
\end{small}
\vspace{-35pt}
\end{wraptable}

Para poder realizar la calibración pertinente es necesario determinar 12 parámetros: las ganancias y bias de los 3 ejes y los 6 ángulos de la matriz $T^p_a$. Para determinar dichos parámetros es conveniente obtener el doble o triple de medidas que de parámetros. Las medidas a realizar son las siguientes:

Con un total de 9 configuraciones diferentes, donde cada una de ellas aporta 3 medidas (una por cada eje), se utilizarán un total de 27 medidas para determinar los 12 parámetros involucrados.

\vspace{-5pt}
\subsubsection*{Preparación}

\begin{wrapfigure}{l}{0.6\textwidth}
  \vspace{-30pt}
  \begin{center}
    \includegraphics[width=0.45\textwidth]
    	{./pics_gyro/escuadra.pdf}
  \end{center}
  \vspace{-20pt}
  \caption{Escuadras}
  \label{fig:escuadras}
\end{wrapfigure}

Las medidas consisten básicamente en rotar la IMU a la velocidad del tocadiscos en las posiciones listadas en la tabla \ref{tab:gyros}, donde \textbf{EGP} es el eje de giro principal, \textbf{EGS} es el eje de giro secundario, y \textbf{AG} es el ángulo de giro.

Con el cubo de madera se resuelven las rotaciones de 90 grados para alinear los tres ejes principales de la IMU con el eje de giro del tocadiscos. Los giros en el eje secundario se realizan utilizando las escuadras y la madera de 4 cm de ancho y lados paralelos, como se muestra en la figura \ref{fig:escuadras}. Apoyando el cubo sobre la escuadra se logran los ángulos de $30º$ y $45º$ deseados en las direcciones de giro secundarias.\\

Si bien la velocidad de giro estándard del tocadiscos es 33.3 rpm, resulta conveniente medir la velocidad del tocadiscos para corroborarla. Se mide la velocidad con el dispositivo IR y se verifica el buen funcionamiento del tocadiscos.\\

Un esquema completo de la configuración utilizada para la calibración del girósopo se puede ver en la figura \ref{fig:tocadiscos}.

\begin{figure}[h!]
	\centering
	\includegraphics[width=.9\textwidth]{./pics_gyro/tocadiscos.jpg}
	\caption{Tocadiscos}
	\label{fig:tocadiscos}
\end{figure}


\section{Resultados y análisis}
\subsection{Medidas para la determinaci\'on de los par\'ametros est\'aticos del giróscopo}
Se pone el tocadiscos a girar y mediante la conexión Wi-Fi se indica a la \emph{BeagleBoard XM} que empiece y termine de logear los datos. Se trabaja con el promedio de las velocidades angulares obtenidas en series de datos de 20 segundos controlados por cronómetro. La velocidad del tocadiscos permanece constante en todas las pruebas y lo que se varía es el ángulo del plano donde se apoya el cubo, haciendo uso de las escuadras (figura \ref{fig:escuadras}).\\

La IMU arroja datos enteros en complemento a dos. La hoja de datos del fabricante asegura que la relaci\'on entre bits y $grados/segundo$ es: $14.375\quad LSB/(º/s)$. Como se desea trabajar con velocidades angulares en $rad/s$ se tiene que la ganancia ser\'a $\approx 823.6$.\\

Al igual que con la calibración del acelerómetro (capítulo \ref{chap:calibracion_acelerometro}), se utiliza la función \emph{lsqnonlin} de \emph{Matlab} para ajustar las medidas obtenidas contra los valores teóricos para cada configuración. De acuerdo a lo anterior, se supone una semilla para las ganancias en los 3 ejes es el vector $G=[823.6;\quad 823.6;\quad 823.6]$. A su vez se supone que cada offset de cada eje será cercano a 0 y que los ángulos debidos a la no-ortogonalidad de los ejes es despreciable, se llega a que una buena semilla para la función $lsqnonlin$ es la siguiente:
$$\zeta _0=\left[823.6,823.6,823.6,0,0,0,0,0,0,0,0,0\right]$$
Los parámetros que minimizan la suma de los errores al cuadrado son los siguientes:
\begin{scriptsize}
\begin{equation}
\theta=\left[
 796.6646 ; 808.2419 ; 803.4482 ; -25.3819 ; -15.7210 ; -1.8871; 0.0093 ; 0.0659 ; 0.0093 ; 0.0128 ; -0.0250 ; 0.0552  \right]
\end{equation}
\end{scriptsize}
Es interesante destacar que el vector $\theta$ hallado es similar a la semilla propuesta, por lo que podemos afirmar que el mínimo local encontrado por la función $lsqnonlin$ es el deseado.\\

Una buena medida de los resultados obtenidos se puede obtener al analizar el promedio de los errores cometidos ($\mu$) y la desviación estándar ($\sigma$):

\begin{equation}
\mu=0.01877 \quad (rad/s)
\label{ec:mu_gyro}
\end{equation}

\begin{equation}
\sigma=0.0231 \quad (rad/s)
\label{ec:sigma_gyro}
\end{equation}

El error promedio corresponde a una velocidad angular de $1.07^\circ/s$ y $2\sigma$ corresponde a una velocidad angular de $2.64^\circ/s$. Estos valores son suficientemente pequeños en comparaci\'on con las velocidades angulares t\'ipicas a las cuales se encontrar\'a sometido el cuadric\'optero y por ende puede considerarse que la calibraci\'on ralizada es aceptable.


%
%Como se mencionó anteriormente, en la hoja de datos del giróscopo se indica una ganancia de $14.375\quad LSB/(º/s)$, lo cual implica que un cambio en el bit menos significativo de la medida del giróscopo, se traduce en un cambio de:
%\begin{equation}
%r=0.0696 \quad (º/s)
%\label{ec:fs}
%\end{equation}
%Es interesante comprar la resolución del instrumento ($r$) con la desviación estándar obtenida. Se obtiene que la desviación estándar es 2 veces y media más chica que la resolución del instrumento, llegando a un resultado absurdo. Lo que sucede es que la desviación estándar fue calculada en base a las medidas tomadas para calibrar, por lo cual carece de sentido ya que la función $lsqnonlin$ minimiza el error cuadrático medio de esas medidas. Para obtener una desviación estándar válida se deben realizar otras medidas distintas y basarse en ellas para hallar la desviación estándar.
%
%% TODO hacer lo anterior - el sigma esta mal calculado
%
%\subsection{Análisis de Resolución}
%
%Se analizan los resultados obtenidos para una configuración en particular: girando según ``z'' a la velocidad del tocadiscos (200 $º/s$), a modo de ejemplo. Se obtiene la gráfica mostrada en la figura \ref{fig:wcalibradolejos}
%
%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=.8\textwidth]{./pics_gyro/wcalibradolejos.pdf}
%	\caption{Resultados luego de calibrar}
%	\label{fig:wcalibradolejos}
%\end{figure}
%
%Se puede ver a simple vista que los resultados obtenidos son muy similares a los esperados, obteniendo los siguientes valores promedio:
%\begin{table}[H]
%\centering
%\begin{small}
%\begin{tabular}{|c|c|c|}
%\hline
%\multicolumn{3}{|c|}{\cellcolor[gray]{0.8} \centering \textbf{Aceleración angular ($º/s$)}}\\ \hline
%  {\cellcolor[gray]{0.9} \centering \textbf{x}}
%& {\cellcolor[gray]{0.9} \centering \textbf{y}}
%& {\cellcolor[gray]{0.9} \centering \textbf{z}} \\ \hline  \hline
%-3.80 & -3.65 & 200.16 \\ \hline
%\end{tabular}
%\caption{Resultados ejemplo luego de la calibración}
%\label{tab:resultados-ejemplo}
%\end{small}
%\end{table} 
%
%Es posible notar una oscilación sobre todo en la medida de $w_z$. Dicha oscilación se da a 45 rpm aproximadamente. Si bien no se tiene certeza de su procedencia, es probable que provenga del propio tocadiscos. El mismo posee la posibilidad de girar a 2 velocidades distintas, 33.33rpm (la utilizada) y 45 rpm. Es viable pensar que dentro del tocadiscos hay un solo motor que gira a 45 rpm y se logran los 33.33 rpm mediante una reducción mecánica. De alguna manera el motor podría estar introduciendo una oscilación a su velocidad de giro.\\
%
%Realizando un acercamiento a la velocidad angular obtenida en el eje ``z'' es posible divisar algunos fenómenos interesantes. Analizando la figura \ref{fig:wcalibradocerca} se pueden divisar 2 saltos distintos, como si se contara con 2 resoluciones distintas.
%
%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=.8\textwidth]{./pics_gyro/wcalibradocerca.png}
%	\caption{Acercamiento de los resultados luego de calibrar}
%	\label{fig:wcalibradocerca}
%\end{figure}
%
%Uno de ellos, el más grande, es de aproximadamente $1 º/s$, mientras que el otro, que se observa en el acercamiento realizado en dicha figura, es de aproximadamente $0.05º/s$. Éste último es comparable con el valor hallado de la desviación estándar por lo que puede pensarse como una verificación de la coherencia de los datos obtenidos y calibrados. Por otra parte, los saltos de $1º/s$ no parecen tener, a priori, un sentido claro. Analizando el código que corre internamente en la IMU se detectó el causante de dichos saltos. Resulta que a la hora de enviar los datos, la imu realiza un $cast$ de los valores expresados en punto flotante a entero, lo cual se traduce en una pérdida aberrante de la resolución del instrumento de medida. Es evidente que el código será retocado para evitar esta pérdida de información en el futuro. Por otro lado es importante destacar que este error no afecta al proceso de calibración realizado, ya que se tomaron medidas de velocidades angulares constantes durante todo el tiempo de muestreo y se realizó un promedio de cada tirada, logrando valores más robustos ante dicho fenómeno.

\subsection{Variación con la temperatura}

Como fue explicado en el capítulo \ref{chap:calibracion_acelerometro}, la temperatura de trabajo de la IMU es significativamente mayor que la temperatura para la cual fueron calibrados los sensores. Para aplicar una compensación por temperatura a la medida del giróscopo, se utiliza un método idéntico al utilizado para el acelerómetro: se varía la temperatura desde una temperatura aproximada de $48^oC$ hasta $35^oC$ y se releva la curva de velocidad angular medida contra temperatura.

\begin{figure}[h!]
	\centering
	\includegraphics[width=.7\textwidth]{./pics_gyro/wtemp.pdf}
	\caption{Variación de la velocidad angular con la temperatura}
	\label{fig:wtemp}
\end{figure}

\begin{figure}[h!]
	\centering
	\includegraphics[width=.9\textwidth]{./pics_gyro/wcompensado.pdf}
	\caption{Velocidad angular compensada por temperatura}
	\label{fig:wcomp}
\end{figure}

Al modelo utilizado para el acelerómetro se le agrega un término de offset independiente de la temperatura, que se introduce para tomar en cuenta que la calibración en el tocadiscos puede no haber eliminado completamente el offset.

Recordando la ecuación \ref{ec:modelo_gyro}, el nuevo modelo para la velocidad angular es el siguiente:
$$\tilde{\mathbf{w^a}}=K_w(T_a^p)^{-1}\mathbf{w^p}+\mathbf{b}_w+\mathbf{b}_1(t-t_0)+\mathbf{b}_0'$$
simplemente definiendo $\mathbf{b}_0=\mathbf{b}_w+\mathbf{b}_0'$:
$$\tilde{\mathbf{w^a}}=K_w(T_a^p)^{-1}\mathbf{w^p}+\mathbf{b}_0+\mathbf{b}_1(t-t_0)$$
\end{document}